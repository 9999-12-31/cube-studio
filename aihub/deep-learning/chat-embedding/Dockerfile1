# 构建应用镜像 docker build --network=host -t ccr.ccs.tencentyun.com/cube-studio/aihub:chat-private-knowledge  .
FROM zxdu20/glm-cuda112:latest

WORKDIR /app
USER root
WORKDIR /workspace

ENV TZ Asia/Shanghai
ENV DEBIAN_FRONTEND noninteractive

# 安装中文，和基础的apt工具包
COPY sources.list /etc/apt/sources.list
RUN apt update -y

RUN pip install --upgrade pip

# glm
COPY requirements.txt /workspace/ChatGLM-6B_requirements.txt
RUN pip install -r ChatGLM-6B_requirements.txt -i https://mirrors.aliyun.com/pypi/simple
RUN pip install -U deep_training cpm_kernels icetk deepspeed -i https://mirrors.aliyun.com/pypi/simple

# 安装运维工具
RUN apt install -y -f --no-install-recommends apt-transport-https gnupg2 jq dnsutils iputils-ping net-tools mysql-client locales zip unzip nginx lsof

# 配置cube-studio基础环境
RUN pip3 install celery redis pyarrow requests_toolbelt cryptography tqdm fsspec aiohttp librosa flask werkzeug requests Pillow pysnooper opencv-python numpy && rm -rf ~/.cache

# 安装文本分割embedding工具
RUN apt install -y unzip && wget -O /text2vec-base-chinese.zip https://docker-76009.sz.gfp.tencent-cloud.com/github/cube-studio/chat/text2vec-base-chinese.zip && cd / && unzip /text2vec-base-chinese.zip && rm /text2vec-base-chinese.zip
RUN pip3 install Pillow elasticsearch==7.12.1 jieba==0.42.1 sseclient-py==1.7.2 torch similarities==1.0.4 python-docx PyPDF2


ENV PYTHONPATH /src/:/github/:$PYTHONPATH

WORKDIR /app

COPY * /app/
COPY init.sh /init.sh
RUN bash /init.sh
